<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' />
  <title>Observing Node.js</title>
  <link href='big.css' rel='stylesheet' type='text/css' />
  <link href='highlight.css' rel='stylesheet' type='text/css' />
  <style>
    .new-shiny { background: #aaaaaa; }
    .new-bubblegum { background: #F6BAB8; }
    .new-brunchPink { background: #FB7A9C; }
    .new-supersplit { background: #FB775E; }
    .mystery-box {
      background: url('./media/mystery-box.jpg');
      background-size: 100%;
      width: 110%;
      height: 100%;
    }
    .event-loop {
      background: url('./media/event-loop.png');
      background-size: 100%;
      width: 110%;
      height: 100%;
    }
  </style>
  <script src='big.js'></script>
  <script src='highlight.js'></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>
<body class='dark'>
  <div>
    <span class="supersplit">Observing</span> Node.js <br />
    <span class="brunchPink" style="font-size: 0.4em">@jasnell</span>
  </div>
  <div class='logo'></div>
  <div class="mystery-box"></div>
  <div>
    What's <span class="supersplit">inside</span> the box?
  </div>
  <div>
<pre><code>
const EventEmitter = require('events')

async function a(val) { console.log('A', val) }

setImmediate(() => console.log('B'))

const ee = new EventEmitter()
ee.on('foo', async (val) => {
  process.nextTick((val) => a(val), val++)
  await a(val++)
  a(val)
})

new Promise((res) => {
  for (let n = 0; n < 1e9; n++) {}
  setImmediate(() => console.log('C'))
  process.nextTick(() => res('D'))
  console.log('E')
}).then(console.log);

queueMicrotask(() => console.log('F'));

(async (res) => {
  for (let n = 0; n < 1e6; n++) {}
  process.nextTick(() => console.log('G'))
  return 'H'
})().then(console.log)

process.nextTick(() => console.log('I'))

const promises = [];
let n = 0;
for (; n < 10; n++)
  promises.push(a(n))

setTimeout((val) => ee.emit('foo', val), 1000, n)

console.log('J')

Promise.all(promises)
</code></pre>
    <div>
      https://github.com/jasnell/observing_node/blob/master/example/timing.js
    </div>
  </div>
  <div>
    <ul>
      <li><code>Promise</code></li>
      <li><code>EventEmitter</code></li>
      <li><code>async/await</code></li>
      <li><code>process.nextTick()</code></li>
      <li><code>setImmediate()</code></li>
      <li><code>setTimeout()</code></li>
      <li><code>setInterval()</code></li>
      <li><code>queueMicrotask()</code></li>
    </ul>
  </div>
  <div>
    JavaScript<br />
    <span class="supersplit">is not</span>
    <span class="bubblegum">asynchronous</span>.
  </div>
  <div>
    <span class="supersplit">File</span> and
    <span class="bubblegum">Network</span> i/o is
    asynchronous.
  </div>
  <div>
    <span class="supersplit">Events</span>
    <span class="bubblegum">are</span> asynchronous.
  </div>
  <div>
    JavaScript<br />
    <span class="supersplit">is not</span>
    <span class="bubblegum">asynchronous</span>.
  </div>
  <div>
    When asynchronous things happen,
    the results are 
    <span class="bubblegum">processed synchronously</span>.
  </div>
  <div>
    <img src="media/event-loop.png" width="100%" height="100%"/>
  </div>
  <div>
    <img src="media/sorting.gif" width="100%" height="100%" />
  </div>
  <div>
    The event loop can only execute one synchronous task at a time.
  </div>
  <div>
    Whenever JavaScript is <span class="supersplit">running</span><br />
    the Event Loop<br /><span class="bubblegum">is not</span>
  </div>
  <div>
    Event Loop <span class="supersplit">Delay</span> :-(
  </div>
  <div>
    <span class="supersplit">Trick Question</span>:<br />
    Does all JavaScript in
    <span class="bubblegum">Node.js</span>
    run within the event loop?
  </div>
  <div>
    <span class="supersplit">Trick Question</span>:<br />
    Does all JavaScript in
    <span class="bubblegum">Node.js</span>
    run within the <i><u>same</u></i> event loop?
  </div>
  <div>
    Bootstrap &raquo;
    Main &raquo;
    EventLoop
  </div>
  <div>
    Bootstrap is when Node.js
    <span class="supersplit">loads it's own</span> JavaScript...
  </div>
  <div>
    Main is when Node.js 
    <span class="supersplit">initially</span> executes user code...
  </div>
  <div>
    The Event Loop is only started
    <span class="supersplit">after main scope</span> exits...
  </div>
  <div>
    But <span class="supersplit">only</span> if asynchronous tasks
    were scheduled...
  </div>
  <div>
<pre><code>
// hello.js
for (let m = 0; m < 1e9; m++) {}

$ node hello
</code></pre>
  </div>
  <div>
<pre><code>
const { performance } = require('perf_hooks')

// hello.js
for (let m = 0; m < 1e9; m++) {}

console.log(performance.nodeTiming.loopStart)  // -1
</code></pre>
  </div>
  <div>
<pre><code>
const { performance } = require('perf_hooks')

// hello.js
for (let m = 0; m < 1e9; m++) {}

setImmediate(() => console.log(performance.nodeTiming.loopStart))
</code></pre>
  </div>
  <div>
    Why is this <span class="supersplit">important</span>?
  </div>

  <div>
<pre><code>
const EventEmitter = require('events')

async function a(val) { console.log('A', val) }

setImmediate(() => console.log('B'))

const ee = new EventEmitter()
ee.on('foo', async (val) => {
  process.nextTick((val) => a(val), val++)
  await a(val++)
  a(val)
})

new Promise((res) => {
  for (let n = 0; n < 1e9; n++) {}
  setImmediate(() => console.log('C'))
  process.nextTick(() => res('D'))
  console.log('E')
}).then(console.log);

queueMicrotask(() => console.log('F'));

(async (res) => {
  for (let n = 0; n < 1e6; n++) {}
  process.nextTick(() => console.log('G'))
  return 'H'
})().then(console.log)

process.nextTick(() => console.log('I'))

const promises = [];
let n = 0;
for (; n < 10; n++)
  promises.push(a(n))

setTimeout((val) => ee.emit('foo', val), 1000, n)

console.log('J')

Promise.all(promises)
</code></pre>
  </div>
  <div>
    <span class="supersplit">First Rule</span>
    of Node.js <span class="bubblegum">Performance</span>:<br />
    Know what your event loop is doing
  </div>
  <div>
    So <span class="supersplit">how</span> do we do that?
  </div>
  <div>
      <span class="supersplit">Trace</span> Events
  </div>
  <div>
    Async <span class="supersplit">Hooks</span>
  </div>
  <div>
      <span class="supersplit">Bubble</span> Profiling
  </div>

  <div>
<pre><code>chrome://tracing</code></pre>
  </div>
  <div>
    <span class="bubblegum">Bootstrap</span> Trace Events
  </div>
  <div>
<pre><code>
$ node --trace-event-categories=v8,node.vm,node.bootstrap timing.js
</code></pre>
  </div>
  <div>
<pre><code>
$ node --trace-event-categories=node.perf
</code></pre>
  </div>
  <div>
<pre><code>
const { performance } = require('perf_hooks')

const {
  Worker, isMainThread, parentPort, workerData
} = require('worker_threads')

if (isMainThread) {
  performance.mark('A')
  const worker = new Worker(__filename)
  worker.on('exit', () => {
    performance.mark('B')
    performance.measure('A to B', 'A', 'B')
  })
} else {
  // This runs in a separate thread & event loop
  setTimeout(() => {}, 2000);
}
</code></pre>
  </div>
  <div>
    <span class="bubblegum">Async</span> Trace Events
  </div>
  <div>
<pre><code>
$ node --trace-event-categories=node.async_hooks timing.js
</code></pre>
  </div>
  <div>
    A Resource is a
    <span class="supersplit">persistent object</span> that
    generates events asynchronously over time.
    (examples: Sockets, Promises)
  </div>
  <div>
    A Request performs
    <span class="supersplit">one task</span>
    asynchronously once. (example: Reading a file)
  </div>
  <div>
    The Trace Event Viewer is OK, but...
  </div>
  <div>
    Clinic.js<br />
    <div style="align:center">
    <img src="media/doctor.png" style="width: 30%" />
    <img src="media/flame.png" style="width: 30%" />
    <img src="media/bubbleprof.png" style="width: 30%" />
    </div>
    <span style="font-size: 0.7em">https://clinicjs.org</span>
  </div>
  <div>
<pre><code>
$ npm i -g clinic

// or

$ yarn global add clinic
</code></pre>
  </div>
  <div>
<pre><code>
$ clinic bubble -- node timing.js
</code></pre>
https://bit.ly/2Fr2t4J
  </div>
  <div>
    <span class="supersplit">Trick Question</span>: Are Promises Asynchronous?
  </div>
  <div>
    <span class="supersplit">Trick Question</span>: Do Promises ever <i>execute</i> concurrently?
  </div>
  <div>
<pre><code>
// Promise.all()

'use strict'

async function foo() {
  for (let m = 0; m < 1e9; m++) {}
  return 'foo'
}

async function bar() {
  for (let m = 0; m < 1e6; m++) {}
  return 'bar'
}

async function all() {
  return await Promise.all([foo(), bar()])
}

all().then(console.log)
</code></pre>
  </div>
  <div>
<pre><code>
// Promise.race()

'use strict'

async function foo() {
  for (let m = 0; m < 1e9; m++) {}
  return 'foo'
}

async function bar() {
  for (let m = 0; m < 1e6; m++) {}
  return 'bar'
}

async function race() {
  return await Promise.race([foo(), bar()])
}

race().then(console.log)
</code></pre>
  </div>
  <div>
<pre><code>
'use strict'

const { promisify } = require('util')
const timeout = promisify(setTimeout)

async function foo() {
  await timeout(10000)
  return 'foo'
}

async function bar() {
  await timeout(1000)
  return 'bar'
}

async function race() {
  return await Promise.race([foo(), bar()])
}

race().then(console.log)
</code></pre>
  </div>
  <div>
    Again... Why is this <span class="supersplit">important</span>?
  </div>
  <div>
<pre><code>
'use strict'

async function everythingIsFine() {
  for (let m = 0; m < 1e9; m++) {}
  return 'A'
}

async function doBadThings() {
  const tasks = [];
  for (let n = 0; n < 10; n++) {
    tasks.push(everythingIsFine())
  }
  return await Promise.all(tasks)
}

doBadThings().then(() => console.log('done!'))
</code></pre>
  </div>
  <div>
<pre><code>
$ clinic bubble -- node promises.js
</code></pre>
  </div>
  <div>
    The Microtask Queue & Next Tick Queue
  </div>
  <div>
    <a href="https://upload.clinicjs.org/public/737b85fec41b8b45042f3b7411dcbf26a5164694efe0a7ef324197052459971a/32.clinic-bubbleprof.html">A real world example</a>
  </div>
</body>
</html>
